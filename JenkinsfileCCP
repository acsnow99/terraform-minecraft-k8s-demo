pipeline {
    agent any
    environment {
        HARBOR_ADDRESS = "172.21.6.192"
        RELEASE = "1.14.4"
    SERVERTYPE = "VANILLA"
    MODPACK = ""
    DOCKER_REPO="${HARBOR_ADDRESS}/itzg/minecraft-server"
    }
    stages {
        stage('Build') {
            steps {
        echo 'Build stuff'
        sh "cat resources/mc-pod-jenkins.yaml > resources/deployment.yaml"
        sh "cat resources/pvc-jenkins.yaml > resources/pvc-deployment.yaml"
        //| sed "s/{{BUILD_NUMBER}}/$BUILD_NUMBER/g"
            }
        }
        stage('Test') {
            steps {
                echo 'Run your test scripts here.'
            }
        }
        stage('Deploy') {
            steps {
        sh "kubectl --kubeconfig ~/.kube/kubeconfig-harbor-tenant.yaml -n minecraft apply -f resources/deployment.yaml"
        sh "kubectl --kubeconfig ~/.kube/kubeconfig-harbor-tenant.yaml -n minecraft apply -f resources/pvc-deployment.yaml || true"
        sh 'kubectl -n minecraft get pods'
            }
        }
        stage('Server Setup') {
            steps {
        sh "sleep 45"
        sh "kubectl --kubeconfig ~/.kube/kubeconfig-harbor-tenant.yaml -n minecraft cp ./resources/server.properties.provisioned mc-server-pod-java:/data/server.properties"
        sh "kubectl --kubeconfig ~/.kube/kubeconfig-harbor-tenant.yaml -n minecraft exec mc-server-pod-java chmod 777 server.properties"
        sh "kubectl --kubeconfig ~/.kube/kubeconfig-harbor-tenant.yaml -n minecraft delete pod mc-server-pod-java"
        sh "kubectl --kubeconfig ~/.kube/kubeconfig-harbor-tenant.yaml -n minecraft apply -f ./resources/mc-pod-provisioned.yaml"
            }
        }
    }
}